<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job - Lineu</title>
  <style>
    :root {
      --bg: #0d0d0d;
      --bg-surface: #1a1a1a;
      --text: #f0f0ec;
      --text-muted: #888;
      --border: #333;
      --accent: #f97316;
      --success: #22c55e;
      --error: #ef4444;
      --warning: #f59e0b;
      --info: #6366f1;
    }
    * { box-sizing: border-box; }
    body { background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; max-width: 1200px; margin: 0 auto; padding: 1rem; }
    a { color: var(--accent); }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .status { padding: 0.25rem 0.75rem; border-radius: 4px; font-weight: 600; color: white; }
    .status.pending { background: var(--warning); }
    .status.processing { background: var(--info); }
    .status.completed { background: var(--success); }
    .status.failed { background: var(--error); }
    .status.duplicate { background: var(--text-muted); }
    .section { background: var(--bg-surface); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .section h2 { margin-top: 0; font-size: 1rem; color: var(--text); }
    pre { background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 6px; overflow: auto; max-height: 400px; font-family: 'SF Mono', Monaco, monospace; font-size: 13px; line-height: 1.5; margin: 0; }
    .meta { color: var(--text-muted); font-size: 0.875rem; }
    .linear-link { background: #5e6ad2; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; text-decoration: none; font-size: 0.875rem; }
    .error-banner { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--error); color: var(--error); padding: 1rem; border-radius: 6px; margin-bottom: 1rem; }
    .back-link { color: var(--accent); text-decoration: none; font-size: 0.875rem; }
    .back-link:hover { text-decoration: underline; }

    /* Tabs */
    [role="tablist"] {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1rem;
    }
    [role="tab"] {
      background: transparent;
      border: none;
      padding: 0.75rem 1.25rem;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      position: relative;
      transition: color 0.15s;
    }
    [role="tab"]:hover { color: var(--text); }
    [role="tab"][aria-selected="true"] { color: var(--accent); }
    [role="tab"][aria-selected="true"]::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent);
    }
    [role="tab"]:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: -2px;
    }
    [role="tab"][hidden] { display: none; }
    [role="tabpanel"][hidden] { display: none; }

    /* Session Timeline */
    .session { display: flex; flex-direction: column; gap: 0.5rem; }
    .event { padding: 0.5rem 0.75rem; border-radius: 4px; border-left: 3px solid var(--border); background: var(--bg-surface); }
    .event .time { color: var(--text-muted); font-size: 0.75rem; font-family: monospace; }
    .event.text { border-left-color: var(--info); }
    .event.tool_use { border-left-color: var(--warning); }
    .event.tool_result { border-left-color: var(--success); }
    .event.error { border-left-color: var(--error); background: rgba(239, 68, 68, 0.1); }
    .event.result { border-left-color: var(--success); background: rgba(34, 197, 94, 0.1); }
    .event .tool { font-weight: 600; color: var(--warning); }
    .event .tool-input { font-family: monospace; font-size: 0.85rem; color: var(--text-muted); }
    .event .result-output { font-family: monospace; font-size: 0.8rem; color: var(--text-muted); max-height: 100px; overflow: auto; background: var(--bg); padding: 0.5rem; border-radius: 4px; margin-top: 0.25rem; white-space: pre-wrap; }
  </style>
</head>
<body>
  <a href="/dashboard/" class="back-link">&larr; Voltar ao Dashboard</a>

  <div class="header">
    <div>
      <h1 style="margin:0">Job #<span id="job-id">-</span></h1>
      <p class="meta" id="job-meta"></p>
    </div>
    <div>
      <span id="job-status" class="status">-</span>
      <a id="linear-link" class="linear-link" style="display:none" target="_blank"></a>
      <button id="create-issue-btn" onclick="createIssue()" style="display:none;margin-left:0.5rem;background:var(--accent);color:white;border:none;padding:0.25rem 0.75rem;border-radius:4px;cursor:pointer;font-size:0.875rem;">Create Linear Issue</button>
    </div>
  </div>

  <div id="error-banner" class="error-banner" style="display:none"></div>

  <!-- Tabs -->
  <div role="tablist" aria-label="Detalhes do Job">
    <button role="tab" id="tab-payload" aria-selected="true" aria-controls="panel-payload" tabindex="0">Payload</button>
    <button role="tab" id="tab-session" aria-selected="false" aria-controls="panel-session" tabindex="-1" hidden>Session</button>
    <button role="tab" id="tab-analysis" aria-selected="false" aria-controls="panel-analysis" tabindex="-1" hidden>Analysis</button>
  </div>

  <!-- Payload Panel -->
  <div role="tabpanel" id="panel-payload" aria-labelledby="tab-payload">
    <div class="section">
      <h2>Payload</h2>
      <pre id="payload"></pre>
    </div>
  </div>

  <!-- Session Panel -->
  <div role="tabpanel" id="panel-session" aria-labelledby="tab-session" hidden>
    <div class="section">
      <h2>Claude Session <span id="session-stats" class="meta"></span></h2>
      <div id="session" class="session"></div>
    </div>
  </div>

  <!-- Analysis Panel -->
  <div role="tabpanel" id="panel-analysis" aria-labelledby="tab-analysis" hidden>
    <div class="section">
      <h2>Analysis</h2>
      <pre id="analysis"></pre>
    </div>
  </div>

  <script>
    const jobId = new URLSearchParams(window.location.search).get('id');
    document.getElementById('job-id').textContent = jobId;

    // Tab switching
    const tabs = document.querySelectorAll('[role="tab"]');
    const panels = document.querySelectorAll('[role="tabpanel"]');

    function activateTab(index) {
      tabs.forEach((tab, i) => {
        const selected = i === index;
        tab.setAttribute('aria-selected', selected);
        tab.tabIndex = selected ? 0 : -1;
        panels[i].hidden = !selected;
      });
    }

    tabs.forEach((tab, i) => {
      tab.onclick = () => activateTab(i);
      tab.onkeydown = (e) => {
        const visibleTabs = [...tabs].filter(t => !t.hidden);
        const currentVisibleIndex = visibleTabs.indexOf(tab);
        if (e.key === 'ArrowRight') {
          const next = visibleTabs[(currentVisibleIndex + 1) % visibleTabs.length];
          activateTab([...tabs].indexOf(next));
          next.focus();
        }
        if (e.key === 'ArrowLeft') {
          const prev = visibleTabs[(currentVisibleIndex - 1 + visibleTabs.length) % visibleTabs.length];
          activateTab([...tabs].indexOf(prev));
          prev.focus();
        }
      };
    });

    function formatTime(ts) {
      return new Date(ts).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function renderSession(events) {
      if (!events || events.length === 0) return false;

      const container = document.getElementById('session');
      container.innerHTML = ''; // Clear before rendering (prevents duplication on polling)
      const toolCount = events.filter(e => e.type === 'tool_use').length;
      const resultEvent = events.find(e => e.type === 'result');
      const duration = resultEvent?.duration_ms ? (resultEvent.duration_ms / 1000).toFixed(1) + 's' : '';

      document.getElementById('session-stats').textContent = `(${toolCount} tools, ${duration})`;

      for (const event of events) {
        const div = document.createElement('div');
        div.className = `event ${event.type}`;

        const time = `<span class="time">${formatTime(event.ts)}</span>`;

        switch (event.type) {
          case 'text':
            div.innerHTML = `${time} ${escapeHtml(event.content || '')}`;
            break;
          case 'tool_use':
            const input = Object.entries(event.input || {}).map(([k,v]) => `${k}=${JSON.stringify(v)}`).join(' ');
            div.innerHTML = `${time} <span class="tool">ðŸ”§ ${escapeHtml(event.tool || '')}</span> <span class="tool-input">${escapeHtml(input)}</span>`;
            break;
          case 'tool_result':
            div.innerHTML = `${time} âœ“ ${escapeHtml(event.tool || '')} (${event.lines} lines)
              <div class="result-output">${escapeHtml(event.output || '')}</div>`;
            break;
          case 'result':
            div.innerHTML = `${time} âœ… Analysis complete in ${(event.duration_ms/1000).toFixed(1)}s`;
            break;
          case 'error':
            div.innerHTML = `${time} âŒ ${escapeHtml(event.message || '')}`;
            break;
        }
        container.appendChild(div);
      }
      return true;
    }

    async function loadJob() {
      try {
        const res = await fetch(`/api/dashboard/jobs/${jobId}`);
        if (!res.ok) throw new Error('Job not found');

        const job = await res.json();

        // Status
        const statusEl = document.getElementById('job-status');
        statusEl.textContent = job.status;
        statusEl.className = `status ${job.status}`;

        // Meta
        const created = new Date(job.created_at).toLocaleString('pt-BR');
        const duration = job.processed_at
          ? ((new Date(job.processed_at) - new Date(job.created_at)) / 1000).toFixed(1) + 's'
          : 'in progress';
        document.getElementById('job-meta').textContent = `Created: ${created} | Duration: ${duration}`;

        // Linear link or create button
        if (job.status === 'completed' && !job.linear_issue_id) {
          // Dry-run: show badge and create button (no link)
          const link = document.getElementById('linear-link');
          link.textContent = 'DRY-RUN';
          link.href = '#';
          link.style.display = 'inline-block';
          link.style.background = 'var(--warning)';
          link.onclick = (e) => e.preventDefault();
          document.getElementById('create-issue-btn').style.display = 'inline-block';
        } else if (job.linear_identifier) {
          // Real issue: show link
          const link = document.getElementById('linear-link');
          link.textContent = job.linear_identifier;
          link.href = `https://linear.app/issue/${job.linear_identifier}`;
          link.style.display = 'inline-block';
        }

        // Error
        if (job.error) {
          document.getElementById('error-banner').textContent = job.error;
          document.getElementById('error-banner').style.display = 'block';
        }

        // Payload
        try {
          const payload = JSON.parse(job.payload);
          document.getElementById('payload').textContent = JSON.stringify(payload, null, 2);
        } catch {
          document.getElementById('payload').textContent = job.payload;
        }

        // Session - show tab if has events
        const hasSession = renderSession(job.session);
        document.getElementById('tab-session').hidden = !hasSession;

        // Analysis - show tab if has analysis
        const hasAnalysis = !!job.analysis;
        document.getElementById('tab-analysis').hidden = !hasAnalysis;
        if (hasAnalysis) {
          document.getElementById('analysis').textContent = JSON.stringify(job.analysis, null, 2);
        }

        // Polling while processing
        if (job.status === 'processing') {
          setTimeout(loadJob, 2000);
        }
      } catch (err) {
        document.getElementById('payload').textContent = 'Error: ' + err.message;
      }
    }

    async function createIssue() {
      const btn = document.getElementById('create-issue-btn');
      btn.disabled = true;
      btn.textContent = 'Creating...';

      try {
        const res = await fetch(`/api/dashboard/jobs/${jobId}/create-issue`, {
          method: 'POST'
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Failed to create issue');
        }

        location.reload();
      } catch (err) {
        alert(err.message);
        btn.disabled = false;
        btn.textContent = 'Create Linear Issue';
      }
    }

    loadJob();
  </script>
</body>
</html>
